
\chapter{Proofs for Chapter~\ref{chap:fibalgeffects}}
\label{chap:appendixC6}


\section{Proof of Proposition~\ref{prop:relatingsemanticsoffibeffectterms}}
\label{sect:proofofprop:relatingsemanticsoffibeffectterms}

{
\renewcommand{\thetheorem}{\ref{prop:relatingsemanticsoffibeffectterms}}
\begin{proposition}
Given a well-formed effect term $\lj {\Gamma \vertbar \Delta} T$ derived from $\mathcal{S}_{\text{eff}}$, a computation type $\ul{C}$, value terms $V_{i}$ (for all $x_i \!:\! A_i$ in $\Gamma$), value terms $V'_{\!j}$ (for all $w_{\!j} \!:\! A'_{\!j}$ in $\Delta$), value terms $W_{\sigalgop}$ (for all $\sigalgop : (x \!:\! I) \longrightarrow O$ in $\mathcal{S}_{\text{eff}}$), and a value context $\Gamma'$ such that
\begin{itemize}
\item $\sem{\Gamma'} \in \Set$, 
\item $\sem{\Gamma';V_i}_1 = \id_{\sem{\Gamma'}}  : \sem{\Gamma'} \longrightarrow \sem{\Gamma'}$, and 
\item $(\sem{\Gamma';V_i}_2)_{\gamma\,'} : 1 \longrightarrow $
\\[-7.5mm]

\hspace{1cm} $\sem{x_1 \!:\! A_1, \ldots, x_{i-1} \!:\! A_{i - 1};A_i}_2\, \langle \langle \langle \star , (\sem{\Gamma'; V_1}_2)_{\gamma\,'}(\star) \rangle , \ldots \rangle , (\sem{\Gamma'; V_{i - 1}}_2)_{\gamma\,'}(\star) \rangle$, 
\end{itemize}
together with a value type $A$ and a family of models $\mathcal{M}_{\gamma\,'} : \mathcal{L}_{\mathcal{T}^{d}_{\text{eff}}} \longrightarrow \Set$ (for all $\gamma\,'$ in $\sem{\Gamma'}$) of the Lawvere theory $I_{\mathcal{T}^{d}_{\text{eff}}} : \aleph_{\!\!1}^{\text{op}} \longrightarrow \mathcal{L}_{\mathcal{T}^{d}_{\text{eff}}}$ (where ${\mathcal{T}^{d}_{\text{eff}}} \defeq (\mathcal{S}_{\text{eff}}, \emptyset)$) such that
\index{ T@${\mathcal{T}^{d}_{\text{eff}}}$ (fibred effect theory $(\mathcal{S}_{\text{eff}}, \emptyset)$)}
\begin{itemize}
\item $\sem{\Gamma';A}_1 = \sem{\Gamma'}$, 
\item $\sem{\Gamma';A}_2(\gamma\,') = \mathcal{M}_{\gamma\,'}(1)$,  
\item $\sem{\Gamma';V'_{\!j}}_1 = \id_{\sem{\Gamma'}}  : \sem{\Gamma'} \longrightarrow \sem{\Gamma'}$, 
\item $(\sem{\Gamma';V'_{\!j}}_2)_{\gamma\,'} : 1 \longrightarrow \bigsqcap_{a \in \sem{\Gamma;A'_{\!j}}_2(\gamma)}(\sem{\Gamma';A}_2(\gamma\,'))$, 
\item $\sem{\Gamma';W_{\sigalgop}}_1 = \id_{\sem{\Gamma'}} : \sem{\Gamma'} \longrightarrow \sem{\Gamma'}$, and
\item $(\sem{\Gamma';W_{\sigalgop}}_2)_{\gamma\,'} = \bigsqcap_{\langle i , f \rangle} \sigalgop^{\mathcal{M}_{\gamma\,'}}_{i} \,\comp\,\, \bigsqcap_{\langle i , f \rangle} (\star \mapsto f) \,\comp\,\, \langle \id_1 \rangle_{\langle i , f \rangle}$
\\[-7.5mm]

\hspace{3.5cm} $: 1 \longrightarrow \bigsqcap_{\langle i , f \rangle \in \bigsqcup_{i \in \sem{\diamond;I}_2(\star)} \bigsqcap_{o \in {\sem{x : I ; O}_2\, \langle \star , i \rangle}} (\sem{\Gamma';A}_2(\gamma\,'))} (\sem{\Gamma';A}_2(\gamma\,'))$, 
\end{itemize}
then 
\[
\sem{\Gamma'; \efftrans T {\!\!A; \overrightarrow{V_i}; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_1 = \id_{\sem{\Gamma'}} : \sem{\Gamma'} \longrightarrow \sem{\Gamma'}
\]
and, for all $\gamma\,'$ in $\sem{\Gamma'}$, the function 
\[
(\sem{\Gamma'; \efftrans T {\!\!A; \overrightarrow{V_i}; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\gamma\,'} : 1 \longrightarrow \sem{\Gamma';A}_2(\gamma\,')
\]
is defined and equal to the following composite function:
\[
\xymatrix@C=4em@R=5em@M=0.5em{
1 
\ar[rr]^-{\langle (\sem{\Gamma';V'_{\!j}}_2)_{\gamma\,'} \rangle_{w_{\!j} : A'_{\!j} \in \Delta}}
&&
\bigsqcap_{w_{\!j} : A'_{\!j} \in \Delta} \bigsqcap_{a \in {\sem{\Gamma;A'_{\!j}}_2(\gamma)}} (\sem{\Gamma';A}_2(\gamma\,'))
\ar[d]^-{\cong}
\\
\sem{\Gamma';A}_2(\gamma\,')
&
\mathcal{M}_{\gamma\,'}(1)
\ar[l]^-{=}
&
\mathcal{M}_{\gamma\,'}(\vert \Delta^\gamma \vert)
\ar[l]^-{\mathcal{M}_{\gamma\,'}(\lj {\Delta^\gamma\,\,} {\,T^\gamma})}
}
\]
where $\vert \Delta^\gamma \vert$ denotes the length of the context $\Delta^\gamma$; and where we use the abbreviation
\[
\gamma \,\defeq \langle \langle \langle \star , (\sem{\Gamma'; V_1}_2)_{\gamma\,'}(\star) \rangle , \ldots \rangle , (\sem{\Gamma'; V_n}_2)_{\gamma\,'}(\star) \rangle
\]
\end{proposition}
\addtocounter{theorem}{-1}
}

\begin{proof}
We prove this proposition by induction on the given derivation of $\lj {\Gamma \vertbar \Delta} T$, using the eMLTT$_{\mathcal{T}_{\text{eff}}}$ versions of Propositions~\ref{prop:semweakening2},~\ref{prop:semsubstitution2},~\ref{prop:semweakening5}, and~\ref{prop:semsubstitution5} to relate syntactic weakening and substitution to reindexing along semantic projection and substitution morphisms. 

We discuss all cases of this proof in detail below. In each of the cases, the proof of
\[
\sem{\Gamma'; \efftrans T {\!\!A; \overrightarrow{V_i}; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_1 = \id_{\sem{\Gamma'}} : \sem{\Gamma'} \longrightarrow \sem{\Gamma'}
\]
is straightforward, by combining our assumptions with the definitions of $\sem{-}$ and $\efftrans {-} {}$.

\vspace{0.2cm}

\noindent \textbf{Effect variables:}
In this case, the given derivation ends with 
\[
\mkrule
{\lj {\Gamma \vertbar \Delta_1, w_{\!j} \!:\! A'_{\!j}, \Delta_2} {w_{\!j}\,(V)}}
{
\lj \Gamma {\Delta_1, w_{\!j} \!:\! A'_{\!j}, \Delta_2}
\quad
\vj \Gamma V A'_{\!j}
}
\]

\pagebreak

First, according to the definition of $\efftrans {-} {}$ for effect variables, we have that
\[
(\sem{\Gamma'; \efftrans {w_{\!j}\,(V)} {\!\!A; \overrightarrow{V_i}; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\gamma\,'}
\]
is equal to
\[
(\sem{\Gamma'; V'_{\!j}\, (V[\overrightarrow{V_i}/\overrightarrow{x_i}])}_2)_{\gamma\,'}
\]
which, by unfolding the definition of $\sem -$ for function application, is equal to
\[
\xymatrix@C=5em@R=4em@M=0.5em{
1
\ar[r]^-{(\sem{\Gamma'; V'_{\!j}}_2)_{\gamma\,'}}
&
\bigsqcap_{a \in {\sem{\Gamma;A'_{\!j}}_2(\gamma)}} (\sem{\Gamma';A}_2(\gamma\,'))
\ar[r]^-{\mathsf{proj}_{(\sem{\Gamma;V}_2)_\gamma(\star)}}
&
\sem{\Gamma';A}_2(\gamma\,')
}
\]
where we implicitly make use of the fact that $\sem{\Gamma;A'_{\!j}}_2(\gamma) = \sem{\Gamma';A'_{\!j}[\overrightarrow{V_i}/\overrightarrow{x_i}]}_2(\gamma\,')$ \linebreak and $(\sem{\Gamma;V}_2)_\gamma = (\sem{\Gamma';V[\overrightarrow{V_i}/\overrightarrow{x_i}]}_2)_{\gamma\,'}$, both of which follow from the definition of $\gamma$ and the eMLTT$_{\mathcal{T}_{\text{eff}}}$ versions of the results that relate syntactic substitution to its semantic counterpart (see Propositions~\ref{prop:semsubstitution2} and~\ref{prop:semsubstitution5}).
%


The required equation then follows from the commutativity of the following diagram:
\[
\scriptsize
\xymatrix@C=12em@R=5em@M=0.5em{
1
\ar[r]^-{\langle (\sem{\Gamma';V'_{\!j}}_2)_{\gamma\,'} \rangle_{w_{\!j} : A'_{\!j} \in \Delta}}
\ar@/_2pc/[ddr]^<<<<<<<<<<<<<<<<<<{\!\!\!(\sem{\Gamma';V'_{\!j}}_2)_{\gamma\,'}}
\ar@/_3.5pc/[dddr]^-{\!\!\!(\sem{\Gamma';V'_{\!j}}_2)_{\gamma\,'}}
\ar@/_4.5pc/[ddddr]_>>>>>>>>>>>>>{(\sem{\Gamma'; V'_{\!j}\, (V[\overrightarrow{V_i}/\overrightarrow{x_i}])}_2)_{\gamma\,'}}
&
\bigsqcap_{w_{\!j} : A'_{\!j} \in \Delta} \bigsqcap_{a \in {\sem{\Gamma;A'_{\!j}}_2(\gamma)}} (\sem{\Gamma';A}_2(\gamma\,'))
\ar[r]^-{\cong}
\ar[d]_-{=}_<<<<<<{\dscomment{w_{\!j}\text{'th projection}}\qquad\qquad\quad}^<<<<<{\quad\dscomment{\text{preservation of count. prod.}}}
&
\mathcal{M}_{\gamma\,'}(\vert \Delta^\gamma \vert)
\ar@/^2pc/[ddd]_-{\mathcal{M}_{\gamma\,'}(\lj {\Delta^\gamma\,\,} {\,(w_{\!j}\, (V))^\gamma})}_>>>>>>>>>>>>>>>>>>>>>>>>>>>>>{\dscomment{\text{preservation of count. prod.}}\qquad\qquad\qquad\qquad\qquad\qquad}
\ar@/^1pc/[dl]^-{\cong}
\ar@/_3.5pc/[ddd]_<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<{\mathcal{M}_{\gamma\,'}(\lj {\Delta^\gamma\,\,} {\,x^{(\sem{\Gamma;V}_2)_\gamma(\star)}_{w_{\!j}}})}^>>>>>>>>>>>>>>>>{\,\,\,\,\,\,\qquad\dscomment{\text{def.}}}
\\
&
\bigsqcap_{w_{\!j} : A'_{\!j} \in \Delta} \bigsqcap_{a \in {\sem{\Gamma;A'_{\!j}}_2(\gamma)}} (\mathcal{M}_{\gamma\,'}(1))
\ar[d]_-{{\mathsf{proj}_{w_{\!j}}}}
&
\\
&
\bigsqcap_{a \in {\sem{\Gamma;A'_{\!j}}_2(\gamma)}} (\mathcal{M}_{\gamma\,'}(1))
\ar[d]^-{=}_<<<<<{\dscomment{\text{assumption about } \mathcal{M}_{\gamma\,'}}\quad\!\!\!\!\!}
\ar[dr]_-{\mathsf{proj}_{(\sem{\Gamma;V}_2)_\gamma(\star)}}
&
\\
&
\bigsqcap_{a \in {\sem{\Gamma;A'_{\!j}}_2(\gamma)}} (\sem{\Gamma';A}_2(\gamma\,'))
\ar[d]^>>>>>{\mathsf{proj}_{(\sem{\Gamma;V}_2)_\gamma(\star)}}^<<<<{\qquad\dscomment{\text{assumption about } \sem{\Gamma';A}_2(\gamma\,')}}_{\dscomment{\text{def.}}\quad\,\,\,\,}
&
\mathcal{M}_{\gamma\,'}(1)
\ar@/^2pc/[dl]^-{=}
\\
&
\sem{\Gamma';A}_2(\gamma\,')
}
\]



\vspace{0.75cm}

\pagebreak

\noindent \textbf{Algebraic operations:}
In this case, the given derivation ends with
\vspace{0.2cm}
\[
\mkrulelabel
{\lj {\Gamma \vertbar \Delta} {\sigalgop_V(y.\, T)}}
{
\lj \Gamma \Delta
\quad
\vj \Gamma V I
\quad
\lj {\Gamma, y \!:\! O[V/x] \vertbar \Delta} {T}
}
{(\sigalgop : (x \!:\! I) \longrightarrow O \in \mathcal{S}_{\text{eff}})}
\vspace{0.05cm}
\]

First, according to the definition of $\efftrans - {}$ for algebraic operations, we have that
\[
(\sem{\Gamma'; \efftrans {\sigalgop_V(y.\, T)} {\!\!A; \overrightarrow{V_i}; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\gamma\,'} 
\]
is equal to
\[
(\sem{\Gamma'; {W_{\sigalgop}\,\, \langle V[\overrightarrow{V_i}/\overrightarrow{x_i}] , \lambda\, y \!:\! O[V[\overrightarrow{V_i}/\overrightarrow{x_i}]/x] .\, \efftrans {T} {\!\!A; \overrightarrow{V_i}, y; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}}_2)_{\gamma\,'} 
\]
which, by unfolding the definition of $\sem -$ for function application, pairing, and lambda abstraction, is equal to the following composite function:
\[
\xymatrix@C=6em@R=6em@M=0.5em{
1
\ar[d]_-{(\sem{\Gamma'; W_{\sigalgop}}_2)_{\gamma\,'}} 
\\
\bigsqcap_{\langle i , f \rangle \in \bigsqcup_{i \in \sem{\diamond;I}_2(\star)} \bigsqcap_{o \in {\sem{x : I ; O}_2\, \langle \star , i \rangle}} (\sem{\Gamma';A}_2(\gamma\,'))} (\sem{\Gamma';A}_2(\gamma\,'))
\ar[d]_-{\mathsf{proj}_{\langle (\sem{\Gamma;V}_2)_\gamma(\star) , \langle (\sem{\Gamma'\!, y : O[V[\overrightarrow{V_i}/\overrightarrow{x_i}]/x] ; \efftrans T {}}_2)_{\langle \gamma\,' \!, o \rangle} \rangle_{o \in \sem{x : I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle} \rangle}}
\\
\sem{\Gamma';A}_2(\gamma\,')
}
\]
where, analogously to the case of effect variables, we again implicitly make use of the fact that $\sem{\Gamma;A'_{\!j}}_2(\gamma) = \sem{\Gamma';A'_{\!j}[\overrightarrow{V_i}/\overrightarrow{x_i}]}_2(\gamma\,')$ and $(\sem{\Gamma;V}_2)_\gamma = (\sem{\Gamma';V[\overrightarrow{V_i}/\overrightarrow{x_i}]}_2)_{\gamma\,'}$.

The required equation then follows from the commutativity of the following diagram: 
\[
\scriptsize
\xymatrix@C=6em@R=5em@M=0.5em{
1
\ar[dd]^>>>>>>>>>>>{\langle \id_1 \rangle_{\langle i , f \rangle}}
\ar@/_2pc/[ddddddddd]^-{(\sem{\Gamma'; W_{\sigalgop}}_2)_{\gamma\,'}}^>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>{\quad\qquad\dscomment{\text{assumption about } W_{\sigalgop}}}
\ar[dr]_>>>>>>>>>>>>>>>>>>{\langle \id_1 \rangle_{o \in \sem{x : I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle}\qquad}
\ar[r]^-{\langle (\sem{\Gamma'; V'_{\!j}}_2)_{\gamma\,'} \rangle_{w_{\!j} : A'_{\!j} \in \Delta}}
&
\bigsqcap_{w_{\!j}} \bigsqcap_{a \in \sem{\Gamma;A'_{\!j}}_2(\gamma)}
(\sem{\Gamma';A}_2(\gamma\,'))x
\ar[r]^-{\cong}
&
\mathcal{M}_{\gamma\,'}(\vert \Delta^\gamma \vert)
\ar@/^1pc/[ddddl]_<<<<<<<<{\mathcal{M}_{\gamma\,'}((\lj {\Delta^{\gamma}\,\,} {\,T^{\langle \gamma , o \rangle}})_{1 \,\leq\, o \,\leq\, \vert \sem{x : I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle \vert})}
\ar[ddddd]_>>>>>>>>>>>>>>>>>>>>>>>>>>>>>{\mathcal{M}_{\gamma\,'}(\lj {\Delta^{\gamma}\,\,} {\,\sigalgop_{(\sem{\Gamma;V}_2)_\gamma(\star)}(T^{\langle \gamma , o \rangle})_o})}_>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>{\dscomment{\text{functoriality of } \mathcal{M}_{\gamma\,'}}\quad\,\,\,\,\,\,\,}
\\
&
\bigsqcap_{o \in \sem{x : I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle} 1
\ar[d]_-{\bigsqcap_o ((\sem{\Gamma'\!, y; \efftrans T {}}_2)_{\langle \gamma\,'\!, o \rangle})}^-{\quad\qquad\qquad\dscomment{(*)}}
&
\\
\bigsqcap_{\langle i , f \rangle} 1
\ar@/_2.5pc/[dddr]^<<<<<<<<<<<<<<<<<<<<<<<<<<{\bigsqcap_{\langle i , f \rangle} (\star \,\mapsto\, f)}
&
\bigsqcap_{o} (\sem{\Gamma';A}_2(\gamma\,'))
\ar[d]_-{=}
&
\\
&
\bigsqcap_{o} (\mathcal{M}_{\gamma\,'}(1))
\ar[d]_-{\cong}
&
\\
&
\mathcal{M}_{\gamma\,'}(\vert \sem{x \!:\! I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle \vert)
\ar@/^2pc/[dr]_-{\mathcal{M}_{\gamma\,'}(\lj {\overrightarrow{x_o}\,\,} {\,\sigalgop_{(\sem{\Gamma;V}_2)_\gamma(\star)}(x_o)_o})\quad}
&
\\
&
\bigsqcap_{\langle i , f \rangle} \bigsqcap_{o \in \sem{x : I; O}_2\, \langle \star , i \rangle} (\sem{\Gamma';A}_2(\gamma\,'))
\ar[d]^-{=}
\ar@/_3.5pc/[ddddl]_-{\bigsqcap_{\langle i , f \rangle} \sigalgop^{\mathcal{M}_{\gamma\,'}}_i\!\!\!\!\!}
&
\mathcal{M}_{\gamma\,'}(1)
\ar[dddd]^-{=}
\\
&
\bigsqcap_{\langle i , f \rangle} \bigsqcap_{o} (\mathcal{M}_{\gamma\,'}(1))
\ar[d]^-{\cong}
&
\\
&
\bigsqcap_{\langle i , f \rangle} (\mathcal{M}_{\gamma\,'}(\vert \sem{x \!:\! I ; O}_2\,\langle \star , i \rangle \vert))
\ar[d]^-{\bigsqcap_{\langle i , f \rangle} (\mathcal{M}_{\gamma\,'}(\lj {\overrightarrow{x_o}\,\,} {\,\sigalgop_i(x_o)_o}))}_-{\dscomment{\text{def. of } \sigalgop^{\mathcal{M}_{\gamma\,'}}_i}\qquad\qquad\quad}
&
\\
&
\bigsqcap_{\langle i , f \rangle} (\mathcal{M}_{\gamma\,'}(1))
\ar[dl]_-{=}^<<<<<<<<<<{\quad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\dscomment{\text{projections from countable products}}}
&
\\
\bigsqcap_{\langle i , f \rangle} (\sem{\Gamma';A}_2(\gamma\,'))
\ar[rr]_-{\mathsf{proj}_{\langle (\sem{\Gamma;V}_2)_\gamma(\star) , \langle (\sem{\Gamma'\!, y : O[V[\overrightarrow{V_i}/\overrightarrow{x_i}]/x] ; \efftrans T {}}_2)_{\langle \gamma\,' \!, o \rangle} \rangle_{o \in \sem{x : I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle} \rangle}}
&
&
\sem{\Gamma';A}_2(\gamma\,')
}
\]
where, for better readability, we abbreviate some of the indices of countable products. For the same reason, we also write the value context $\Gamma'\!, y \!:\! O[V[\overrightarrow{V_i}/\overrightarrow{x_i}]/x]$ as $\Gamma'\!, y$.

In the previous diagram, $(*)$ refers to the following commuting diagram:
\[
\scriptsize
\xymatrix@C=3.5em@R=6em@M=0.5em{
1
\ar[d]^-{\langle \id_1 \rangle_{o \in \sem{x : I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle}\qquad}^<<<<<<<<{\quad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\dscomment{\text{pairing for countable products}}}
\ar[rr]^-{\langle (\sem{\Gamma'; V'_{\!j}}_2)_{\gamma\,'} \rangle_{w_{\!j} : A'_{\!j} \in \Delta}}
&
&
\bigsqcap_{w_{\!j}} \bigsqcap_{a \in \sem{\Gamma;A'_{\!j}}_2(\gamma)}
(\sem{\Gamma';A}_2(\gamma\,'))
\ar[ddd]^-{\cong}_-{\dscomment{\text{preservation of countable products}}\quad}
\ar[ddl]_-{\langle \id_{\bigsqcap_{w_{\!j}} \bigsqcap_{a \in \sem{\Gamma;A'_{\!j}}_2(\gamma)}
(\sem{\Gamma';A}_2(\gamma\,'))} \rangle_{o}\!\!\!\!}
\\
\bigsqcap_{o \in \sem{x : I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle} 1
\ar@/_1.5pc/[ddr]_>>>>>>>>>>>>>>>{\bigsqcap_{o} (\langle (\sem{\Gamma'\!, y ; V'_{\!j}}_2)_{\langle \gamma\,'\!, o \rangle} \rangle_{w_{\!j}})}
\ar@/_1pc/[dr]^-{\,\,\,\,\quad\bigsqcap_{o} (\langle (\sem{\Gamma'; V'_{\!j}}_2)_{\gamma\,'} \rangle_{w_{\!j}})}
\ar@/_2pc/[ddd]^>>>>>>>>>>>{\bigsqcap_o ((\sem{\Gamma'\!, y; \efftrans T {}}_2)_{\langle \gamma\,'\!, o \rangle})}
&
\\
&
\bigsqcap_{o} \bigsqcap_{w_{\!j}} \bigsqcap_{a} (\sem{\Gamma';A}_2(\gamma\,'))
\ar@/^5.5pc/[dd]^-{\cong}
&
\\
&
\bigsqcap_{o} \bigsqcap_{w_{\!j}} \bigsqcap_{a} (\sem{\Gamma'\!, y;A}_2\, \langle \gamma\,' , o \rangle))
\ar@/_4pc/[dd]_-{\cong}_>>>>>>>>>{\dscomment{\text{induction hypothesis}}\qquad\qquad\qquad\qquad\qquad\qquad}^<<<<<{\qquad\dscomment{\text{weakening}}}
\ar[u]_-{=}^>>>>>{\dscomment{\text{weakening}}\quad}
&
\mathcal{M}_{\gamma\,'}(\vert \Delta^{\gamma} \vert)
\ar@/^1pc/[dl]^>>>>>>>>{\quad\langle \id_{\mathcal{M}_{\gamma\,'}(\vert \Delta^{\gamma} \vert)} \rangle_{o}}
\ar[ddddddd]_>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>{\mathcal{M}_{\gamma\,'}((\lj {\Delta^{\gamma}\,\,} {\,T^{\langle \gamma , o \rangle}})_o)}_<<<<<<<<<<<<<<<<<<<<<<<<<<<<{\dscomment{\text{preservation of countable products}}\quad}
\\
\bigsqcap_{o} (\sem{\Gamma';A}_2(\gamma\,'))
\ar@/_1pc/[ddd]_-{=} \ar@{}[ddd]^>>>>>>>>{\quad\dscomment{\text{weakening}}}
&
\bigsqcap_{o} (\mathcal{M}_{\gamma\,'}(\vert \Delta^{\gamma} \vert))
\ar@/^8pc/[dddd]_-{\bigsqcap_o (\mathcal{M}_{\gamma\,'}(\lj {\Delta^{\gamma}\,\,} {\,T^{\langle \gamma , o \rangle}}))}
&
\\
&
\bigsqcap_{o} (\mathcal{M}_{\langle \gamma\,' , o \rangle}(\vert \Delta^{\langle \gamma , o \rangle} \vert))
\ar[u]_-{=}
\ar[dd]_<<<<<<<<<<<<{\bigsqcap_o (\mathcal{M}_{\langle \gamma\,' , o \rangle}(\lj {\Delta^{\langle \gamma , o \rangle}\,\,} {\,T^{\langle \gamma , o \rangle}}))}^<<<<<<<<{\qquad\dscomment{\text{weakening}}}_<{\dscomment{\text{weakening}}\qquad\qquad\qquad\quad}
\\
&
&
\\
\bigsqcap_o (\mathcal{M}_{\gamma\,'}(1))
\ar@/_7.5pc/[dddrr]_-{\cong}^<<<<<<<<{\quad\qquad\dscomment{\text{weakening}}}
&
\bigsqcap_{o} (\mathcal{M}_{\langle \gamma\,' , o \rangle}(1))
\ar@/^3.5pc/[uuul]^-{=}
\ar[l]_-{=}
\ar[d]_-{=}
\ar@/_4pc/[dd]_-{\cong}^>>>>>{\qquad\dscomment{\text{weakening}}}
\\
&
\bigsqcap_o (\mathcal{M}_{\gamma\,'}(1))
\ar@/^1pc/[ddr]_-{\cong}
\\
&
\mathcal{M}_{\langle \gamma\,' , o \rangle}(\vert \sem{x : I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle \vert)
\ar[dr]_-{=}
&
\\
&
&
\mathcal{M}_{\gamma\,'}(\vert \sem{x : I ; O}_2\,\langle \star , (\sem{\Gamma;V}_2)_\gamma(\star) \rangle \vert)
}
\]

Observe that throughout the last diagram, we have extensively used the eMLTT$_{\mathcal{T}_{\text{eff}}}$ version of Propositions~\ref{prop:semweakening2} and~\ref{prop:semweakening5} to relate syntactic weakening to reindexing along semantic projection morphisms (marked with ``weakening"), e.g., to show that
\[
\sem{\Gamma', y \!:\! O[V[\overrightarrow{V_i}/\overrightarrow{x_i}]/x]; A}_2\, \langle \gamma\,'\!, o \rangle = \sem{\Gamma'; A}_2(\gamma\,')
\]

Further, as we know from our assumptions that $\lj \Gamma \Delta$, analogous equations for all $w_{\!j} \!:\! A'_{\!j}$ in $\Delta$ also enable us extend weakening to derived contexts $\Delta^{\langle \gamma , o \rangle}$, as follows:
\[
\vert \Delta^{\langle \gamma , o \rangle} \vert = \vert \Delta^\gamma \vert
\]

\vspace{0.2cm}

\noindent \textbf{Pattern-matching:} In this case, the given derivation ends with 
\[
\mkrule
{\lj {\Gamma \vertbar \Delta} {\pmatchsf V {(y_1 \!:\! B_1, y_2 \!:\! B_2)} {} T}}
{
\lj \Gamma \Delta 
\quad
\vj \Gamma V \Sigma\, y_1 \!:\! B_1 .\, B_2
\quad
\lj {\Gamma, y_1 \!:\! B_1, y_2 \!:\! B_2 \vertbar \Delta} T
}
\]

First, according to the definition of $\efftrans - {}$ for pattern-matching, we have that
\[
(\sem{\Gamma'; \efftrans {\pmatchsf V {(y_1 \!:\! B_1, y_2 \!:\! B_2)} {} T} {\!\!A; \overrightarrow{V_i}; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\gamma\,'}
\]
is equal to
\[
(\sem{\Gamma'; \pmatch {V[\overrightarrow{V_i}/\overrightarrow{x_i}]} {(y_1 \!:\! B_1[\overrightarrow{V_i}/\overrightarrow{x_i}], y_2 \!:\! B_2[\overrightarrow{V_i}/\overrightarrow{x_i}])} {} {\efftrans T {\!\!A; \overrightarrow{V_i}, y_1, y_2; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}}_2)_{\gamma\,'}
\]
which, by unfolding the definition of $\sem -$ for pattern-matching and assuming that
\[
(\sem{\Gamma';V[\overrightarrow{V_i}/\overrightarrow{x_i}]}_2)_{\gamma\,'}(\star) = (\sem{\Gamma;V})_\gamma (\star) = \langle b_1 , b_2 \rangle
\]
is equal to
\[
(\sem{\Gamma'\!, y_1 \!:\! B_1[\overrightarrow{V_i}/\overrightarrow{x_i}], y_2 \!:\! B_2[\overrightarrow{V_i}/\overrightarrow{x_i}]; \efftrans T {\!\!A; \overrightarrow{V_i}, y_1, y_2; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\langle \langle \gamma\,' \! ,\, b_1 \rangle ,\, b_2 \rangle}
\]

The required equation then follows from the commutativity of the following diagram:
\[
\scriptsize
\xymatrix@C=3em@R=4.5em@M=0.5em{
1
\ar[rr]^-{\langle (\sem{\Gamma'; V'_{\!j}}_2)_{\gamma\,'} \rangle_{w_{\!j} : A'_{\!j} \in \Delta}}
\ar[dddddd]^<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<{(\sem{\Gamma'\!, y_1 , y_2 ; \efftrans T {\!\!A; \overrightarrow{V_i}, y_1, y_2; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\langle \langle \gamma\,' \! ,\, b_1 \rangle ,\, b_2 \rangle}}
\ar@/^2pc/[ddr]^<<<<<<<<<<<<<<<<<<<<<<{\!\!\!\!\langle (\sem{\Gamma'\!, y_1, y_2; V'_{\!j}}_2)_{\langle \langle \gamma\,' \! ,\, b_1 \rangle ,\, b_2\rangle} \rangle_{w_{\!j} : A'_{\!j} \in \Delta}}^<<<<<<<<<<<<<<{\quad\qquad\qquad\qquad\qquad\qquad\dscomment{\text{weakening}}}
&
&
\bigsqcap_{w_{\!j}} \bigsqcap_{a \in \sem{\Gamma;A'_{\!j}}_2(\gamma)}
(\sem{\Gamma';A}_2(\gamma\,'))
\ar[d]^-{\cong}
\\
&
&
\mathcal{M}_{\gamma\,'}(\vert \Delta^\gamma \vert)
\ar@/^1pc/[dddd]_>>>>>>>{\mathcal{M}_{\gamma\,'}(\lj {\Delta^\gamma\,\,} {\,T^{\langle \langle \gamma ,\, b_1 \rangle ,\, b_2 \rangle}})}
\\
&
\bigsqcap_{w_{\!j}} \bigsqcap_{a \in \sem{\Gamma;A'_{\!j}}_2(\gamma)}
(\sem{\Gamma'\!, y_1, y_2;A}_2\, \langle \langle \gamma\,' \!, b_1 \rangle , b_2\rangle)
\ar@/^2pc/[uur]_-{=}_<<<<<<<<<<<<{\qquad\qquad\dscomment{\text{weakening}}}
\ar[d]^-{\cong}
&
\\
&
\mathcal{M}_{\langle \langle \gamma\,' \!, b_1 \rangle , b_2 \rangle}(\vert \Delta^{\langle \langle \gamma ,\, b_1 \rangle ,\, b_2 \rangle} \vert)
\ar@/_2.5pc/[uur]_-{=}
\ar[dd]^-{\mathcal{M}_{\langle \langle \gamma\,' \!, b_1 \rangle , b_2 \rangle}(\lj {\Delta^{\langle \langle \gamma,\, b_1 \rangle ,\, b_2 \rangle}\,\,} {\,T^{\langle \langle \gamma,\, b_1 \rangle ,\, b_2 \rangle}})}_-{\dscomment{\text{induction hypothesis}}\qquad\qquad\qquad}^<<<<{\quad\qquad\qquad\qquad\qquad\dscomment{\text{weakening}}}
\\
&
&
\\
&
\mathcal{M}_{\langle \langle \gamma\,' , b_1 \rangle , b_2 \rangle}(1)
\ar[r]_-{=}
\ar[dl]_-{=}
&
\mathcal{M}_{\gamma\,'}(1)
\ar[d]^-{=}_-{\dscomment{\text{weakening}}\qquad\qquad\qquad\qquad\qquad}
\\
\sem{\Gamma'\!, y_1, y_2;A}_2\, \langle \langle \gamma\,' \! , b_1 \rangle , b_2 \rangle
\ar[rr]_-{=}
&&
\sem{\Gamma';A}_2(\gamma\,')
}
\]

Similarly to the earlier case for algebraic operations, we have again abbreviated some of the value contexts and indices of countable products for better readability.

\vspace{0.2cm}

\noindent \textbf{Case analysis:} In this case, the given derivation ends with 
\[
\mkrule
{\lj {\Gamma \vertbar \Delta} {\mathsf{case~} V \mathsf{~of}_{} \mathsf{~} ({\seminl {\!} {\!\!(y_1 \!:\! B_1)} \mapsto T_1}, {\seminr {\!} {\!\!(y_2 \!:\! B_2)} \mapsto T_2})}}
{
\lj \Gamma \Delta 
\quad
\vj \Gamma V B_1 + B_2
\quad
\lj {\Gamma, y_1 \!:\! B_1 \vertbar \Delta} T_1
\quad
\lj {\Gamma, y_2 \!:\! B_2 \vertbar \Delta} T_2
}
\]

First, according to the definition of $\efftrans - {}$ for case analysis, we have that
\[
(\sem{\Gamma'; \efftrans {\mathsf{case~} V \mathsf{~of}_{} \mathsf{~} ({\seminl {\!} {\!\!(y_1 \!:\! B_1)} \mapsto T_1}, {\seminr {\!} {\!\!(y_2 \!:\! B_2)} \mapsto T_2})} {\!\!A; \overrightarrow{V_i}; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\gamma\,'}
\]
is equal to 
\[
(\sem{\Gamma'; \mathtt{case~} V[\overrightarrow{V_i}/\overrightarrow{x_i}] \mathtt{~of}_{} \mathtt{~} ({\inl {\!} {\!\!(y_1 \!:\! B_1[\overrightarrow{V_i}/\overrightarrow{x_i}])} \mapsto \efftrans {T_1} {}}, {\inr {\!} {\!\!(y_2 \!:\! B_2[\overrightarrow{V_i}/\overrightarrow{x_i}])} \mapsto \efftrans {T_2} {}})}_2)_{\gamma\,'}
\]

\pagebreak
\noindent
which, by unfolding the definition of $\sem -$ for case analysis, is either equal to 
\[
(\sem{\Gamma'\!, y_1 \!:\! B_1[\overrightarrow{V_i}/\overrightarrow{x_i}]; \efftrans {T_1} {\!\!A; \overrightarrow{V_i}, y_1; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\langle \gamma\,' \! ,\, b_1 \rangle}
\]
or 
\[
(\sem{\Gamma'\!, y_2 \!:\! B_2[\overrightarrow{V_i}/\overrightarrow{x_i}]; \efftrans {T_2} {\!\!A; \overrightarrow{V_i}, y_2; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\langle \gamma\,' \! ,\, b_2 \rangle}
\]
depending on whether 
\[
(\sem{\Gamma';V[\overrightarrow{V_i}/\overrightarrow{x_i}]}_2)_{\gamma\,'}(\star) = (\sem{\Gamma;V})_\gamma (\star) = \seminl {} {b_1}
\]
or
\[
(\sem{\Gamma';V[\overrightarrow{V_i}/\overrightarrow{x_i}]}_2)_{\gamma\,'}(\star) = (\sem{\Gamma;V})_\gamma (\star) = \seminr {} {b_2}
\vspace{0.1cm}
\]

The required equation for the $\seminl {} {b_1}$ case then follows from the commutativity of the next diagram, where, similarly to the case for algebraic operations, we again abbreviate some of the value contexts and indices of countable products for better readability.
\[
\scriptsize
\xymatrix@C=4em@R=4.5em@M=0.5em{
1
\ar[rr]^-{\langle (\sem{\Gamma'; V'_{\!j}}_2)_{\gamma\,'} \rangle_{w_{\!j} : A'_{\!j} \in \Delta}}
\ar[dddddd]^<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<{(\sem{\Gamma'\!, y_1; \efftrans T {\!\!A; \overrightarrow{V_i}, y_1; \overrightarrow{V'_{\!j}}; \overrightarrow{W_{\sigalgop}}}}_2)_{\langle \gamma\,' \! ,\, b_1 \rangle}}
\ar@/^2pc/[ddr]^<<<<<<<<<<<<<<<<<<<<<<{\!\!\!\!\!\!\!\!\!\!\!\langle (\sem{\Gamma'\!, y_1; V'_{\!j}}_2)_{\langle \gamma\,' \! ,\, b_1 \rangle} \rangle_{w_{\!j} : A'_{\!j} \in \Delta}}^<<<<<<<<<<<<<{\qquad\qquad\qquad\qquad\dscomment{\text{weakening}}}
&
&
\bigsqcap_{w_{\!j}} \bigsqcap_{a \in \sem{\Gamma;A'_{\!j}}_2(\gamma)}
(\sem{\Gamma';A}_2(\gamma\,'))
\ar[d]^-{\cong}
\\
&
&
\mathcal{M}_{\gamma\,'}(\vert \Delta^\gamma \vert)
\ar@/^1pc/[dddd]_>>>>>>>>{\mathcal{M}_{\gamma\,'}(\lj {\Delta^\gamma\,\,} {\,T^{\langle  \gamma ,\, b_1 \rangle}})}
\\
&
\bigsqcap_{w_{\!j}} \bigsqcap_{a \in \sem{\Gamma;A'_{\!j}}_2(\gamma)}
(\sem{\Gamma'\!, y_1;A}_2\, \langle \gamma\,' \!, b_1 \rangle)
\ar@/^2pc/[uur]_-{=}_<<<<<<<<{\qquad\qquad\dscomment{\text{weakening}}}
\ar[d]^-{\cong}
&
\\
&
\mathcal{M}_{\langle \gamma\,' \!, b_1 \rangle}(\vert \Delta^{\langle \gamma ,\, b_1 \rangle} \vert)
\ar@/_2.5pc/[uur]_-{=}
\ar[dd]^-{\mathcal{M}_{\langle \gamma\,' \!, b_1 \rangle}(\lj {\Delta^{\langle  \gamma,\, b_1 \rangle}\,\,} {\,T^{\langle \gamma,\, b_1 \rangle}})}_-{\dscomment{\text{induction hypothesis}}\qquad\qquad}^<<<<{\qquad\qquad\qquad\qquad\dscomment{\text{weakening}}}
\\
&
&
\\
&
\mathcal{M}_{\langle \gamma\,' , b_1 \rangle}(1)
\ar[r]_-{=}
\ar[dl]_-{=}
&
\mathcal{M}_{\gamma\,'}(1)
\ar[d]^-{=}_-{\dscomment{\text{weakening}}\qquad\qquad\qquad\qquad\qquad}
\\
\sem{\Gamma'\!, y_1;A}_2\, \langle \gamma\,' \! , b_1 \rangle
\ar[rr]_-{=}
&&
\sem{\Gamma';A}_2(\gamma\,')
}
\vspace{0.25cm}
\]

We omit the proof of the other case (for $\seminr {} {b_2}$) because it is proved analogously.
\end{proof}



\renewcommand\thesection{\thechapter.\arabic{section}}

